/// <reference path="jquery.min.js" />
/// <reference path="../data/dictdata.js" />
/// <reference path="rsseasy.min.js" />
/// <reference path="validated.v2.min.js" />
/// <reference path="rsseasy.app.js" />
/// <reference path="rsseasy.adapter.min.js" />
/// <reference path="rsseasy.weixin.js" />
/// <reference path="rsseasy.order.js" />

var RssPay = {}
RssPay.Params = { "adapter": "AliPay", "url": "" };
RssPay.AuthIP = "111.196.82.88";

//myid：支付者ID；orderid：需要支付的订单；channelid：支付的渠道；deviceid：支付的设备识别ID；name：第三方支付商品显示名称
RssPay.PayData = { "myid": "", "orderid": "", "channelid": "", "deviceid": "1", "name": "充值购物" }
RssPay.Adapter = { "1": "RssAliPay", "2": "WeiXinInner", "3": "AliPayWeb", "4": "RssWeiXin", "5": "Cash", "6": "AvailableBalance", "7": "SwipingCard", "8": "AliPayH5", "9": "WeiXinH5" }
RssPay.Module = {}

//支付宝APP集成
RssPay.RssAliPay = function () {
    this.Params.adapter = "AliPay";
    this.onGetOrder = function (json) {
        RssPay.Params.url = json["data"];
        JsAdapter.Push(RssPay.Params).Submit();
    }
    this.PayOrder();
}
RssPay.AliPayH5 = function () {
    this.onGetOrder = function (json) {
        location.href = json["data"];
    }
    this.PayOrder();
}
RssPay.AliPayWeb = function () {
    this.onGetOrder = function (json) {
        location.href = json["data"];
    }
    this.PayOrder();
}
//微信内支付
RssPay.WeiXinInner = function () {
    ValidatedV2.valset(RssUser.Data.openid).setlbl("OpenID不能为空").isNotEmpty();
    this.onGetOrder = function (data) {
        WeixinJSBridge.invoke('getBrandWCPayRequest', data, function (res) {
            RssPay.onPay();
        });
    }
    this.PayOrder($.extend(null, { "openid": RssUser.Data.openid || "", "createip": this.AuthIP }, this.PayData));
}
RssPay.WeiXinH5 = function () {
    this.onGetOrder = function (json) {
        location.href = RssApp.ApiHost + "pay/weixinh5?mweb_url=" + encodeURIComponent(json["mweb_url"]);
    }
    this.PayOrder($.extend(null, { "createip": this.AuthIP }, this.PayData));
}
//APP集成微信内支付
RssPay.RssWeiXin = function () {
    this.onGetOrder = function (json) {
        RssPay.Params.adapter = "WeiXinPay";
        RssPay.Params.url = json["mweb_url"];
        RssPay.Params.referer = RssApp.ApiHost;
        JsAdapter.Push(RssPay.Params).Submit();
    }
    this.PayOrder($.extend(null, { "createip": this.AuthIP }, this.PayData));
}

//现金支付
RssPay.Cash = function () {
    this.onGetOrder = function (json) {
        RssPay.onPay();
    }
    this.PayOrder(this.PayData);
}

//账户可用余额支付
RssPay.AvailableBalance = function () {
    this.onGetOrder = function (json) {
        RssPay.onPay();
    }
    this.PayOrder(this.PayData);
}
//刷卡支付
RssPay.SwipingCard = function () {
    this.onGetOrder = function (json) {
        RssPay.onPay();
    }
    this.PayOrder(this.PayData);
}

RssPay.onGetOrder = function () { }

RssPay.PayOrder = function () {
    RssWin.MaskLayer.show();
    RssWin.LoadBox.show("支付中");
    new Ajax("pay/order").keyvalue(this.PayData).getJson(function (json) {
        RssPay.PayData.orderid = json["orderid"];
        delete json["orderid"];
        RssPay.onGetOrder(json);
    });
}

//支付业务请求提交
RssPay.Submit = function (orderid) {
    try {
        if (orderid) {
            this.PayData.orderid = orderid;
        }
        ValidatedV2.dictset(RssPay.PayData).keyset("channelid").setlbl("支付渠道ID").isNumber();
        var adapter = RssPay.Adapter[RssPay.PayData.channelid];
        if (adapter) {
            RssPay[adapter]();
            return;
        }
        alert("暂不支持");
    } catch (ex) {
        alert(ValidatedV2.label + RssCode.value(ex));
    }
}

//当支付后调用，通过获取订单状态验证支付是否成功，第三方支付接口回调请求后更新支付订单状态
RssPay.onPay = function () {
    new Ajax("pay/verify").keyvalue("orderid", this.PayData.orderid).getJson(function (json) {
        RssWin.MaskLayer.close();
        RssWin.LoadBox.close();
        json["state"] == "1" ? RssPay.onSucceed() : RssPay.onFailure();
    });
}
//当支付成功后
RssPay.onSucceed = function () {
    alert("支付成功");
}
//当支付失败后
RssPay.onFailure = function () {
    alert("支付失败");
}

//moduleid为0系统默认为充值
$("[rsspay]").click(function (ev) {
    RssOrder.addDetails($.extend(null, { "unitprice": 0, "name": "充值", "amount": 1, "moduleid": 0, "relationid": 0 }, $(this).attrmap()));

    var t = $(this);
    RssOrder.onGetOrder = function (json) {
        RssPay.PayData.myid = RssUser.Data.myid;
        RssPay.PayData.orderid = json["orderid"];
        $.extend(RssPay.PayData, t.attrmap());
        console.log(RssPay.PayData);
        RssPay.Submit();
    }
    RssOrder.submit();
});