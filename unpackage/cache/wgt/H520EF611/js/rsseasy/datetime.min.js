/// <reference path="jquery.min.js" />
/// <reference path="sqlitehelper.js" />
/// <reference path="rsseasy.min.js" />

//日期时间选择框

var RssDateTime = { "wrap": $('<div class="dialogbox datatimebox"><header><h2></h2><table></table></header><main></main><footer><button type="button">确定</button><button type="button">取消</button></footer></div>') }

$("body").append(RssDateTime.wrap);
RssDateTime.MainWrap = RssDateTime.wrap.find("main");
RssDateTime.Header = RssDateTime.wrap.find("header");
RssDateTime.Title = RssDateTime.Header.find("h2");  //标题
RssDateTime.defdt = new Date();   //默认显示的日期时间
RssDateTime.Result = new Date().toString("yyyy-MM-dd HH:mm:ss");   //选择的时间日期
RssDateTime.ShowNumber = 5;
RssDateTime.Footer = RssDateTime.wrap.find("footer");
RssDateTime.Confirm = RssDateTime.Footer.find("button").first();

RssDateTime.Footer.click(function () {
    RssWin.MaskLayer.close();
    RssDateTime.wrap.hide();
}).find("button").first().click(function () {
    RssDateTime.onSlideEnd();  //点击确定按钮后回调函数
});

//初始化日期时间选择控件 istime:此参数如果有值，表示设置时间，同时此值为分钟部分的步长，如值大于1不显示秒
RssDateTime.Init = function (istime) {
    istime = parseInt(istime);
    if (istime && istime < 1) {
        istime = 1;
    }
    this.Header.find("table").html("<tr><td>年</td><td>月</td><td>日</td>" + (istime ? "<td>时</td><td>分</td>" + (istime < 2 ? "<td>秒</td>" : "") : "") + "</tr>");

    var mask = "<ol>";
    for (var i = 0; i < this.ShowNumber; i++) {
        mask += '<li></li>';
    }
    mask += '</ol>';

    var wrap = $("<div value='" + this.defdt.getFullYear() + "'></div>"), html = "";
    for (var i = 1970; i < new Date().getFullYear() + 10; i++) {
        html += '<li value="' + i + '">' + i + '</li>';
    }
    wrap.html('<ul>' + html + '</ul>' + mask);
    this.MainWrap.html(wrap);


    wrap = $("<div value='" + (this.defdt.getMonth() + 1) + "'></div>"), html = "";
    for (var i = 1; i < 13; i++) {
        html += '<li value="' + i + '">' + i + '</li>';
    }
    wrap.html('<ul>' + html + '</ul>' + mask);
    this.MainWrap.append(wrap);

    wrap = $("<div value='" + this.defdt.getDate() + "'></div>"), html = "";
    for (var i = 1; i < 31; i++) {
        html += '<li value="' + i + '">' + i + '</li>';
    }
    wrap.html('<ul>' + html + '</ul>' + mask);
    this.MainWrap.append(wrap);

    if (istime) {

        wrap = $("<div value='" + this.defdt.getHours() + "'></div>"), html = "";
        for (var i = 0; i < 24; i++) {
            html += '<li value="' + i + '">' + i + '</li>';
        }
        wrap.html('<ul>' + html + '</ul>' + mask);
        this.MainWrap.append(wrap);

        wrap = $("<div value='" + this.defdt.getMinutes() + "'></div>"), html = "";
        for (var i = 0; i < 60; i += istime) {
            html += '<li value="' + i + '">' + i + '</li>';
        }
        wrap.html('<ul>' + html + '</ul>' + mask);
        this.MainWrap.append(wrap);

        if (istime < 2) {
            wrap = $("<div value='" + this.defdt.getSeconds() + "'></div>"), html = "";
            for (var i = 0; i < 60; i++) {
                html += '<li value="' + i + '">' + i + '</li>';
            }
            wrap.html('<ul>' + html + '</ul>' + mask);
            this.MainWrap.append(wrap);
        }
    }

    var dtft = istime ? "yyyy-MM-dd HH:mm:ss" : "yyyy-MM-dd";
    this.Result = this.defdt.toString(dtft);
    RssDateTime.Title.html(RssDateTime.Result);

    var wraps = RssDateTime.MainWrap.find(">div");
    wraps.find("ol>li:eq(" + (Math.floor(this.ShowNumber / 2)) + ")").addClass("selected");


    //选择事件
    RssDateTime.MainWrap.find(">div").selectslide().on("selectslideend", function (ev, json) {
        var item = wraps.eq(0).attr("value") + "-" + wraps.eq(1).attr("value") + "-" + wraps.eq(2).attr("value") + " " + (wraps.eq(3).attr("value") || "00") + ":" + (wraps.eq(4).attr("value") || "00") + ":" + (wraps.eq(5).attr("value") || "00");

        RssDateTime.Result = new Date(item).toString(dtft);
        RssDateTime.Title.html(RssDateTime.Result);
    });

    var height = wraps.first().find("li").first().height();
    wraps.each(function () {
        wrap = $(this);
        var idx = wrap.find("li[value='" + wrap.attr("value") + "']").index();
        if (idx > 0) {
            wrap.find(">ul").css({ "margin-top": -idx * height });
        }
    });
}
RssDateTime.wrap.click(function (ev) {
    ev.stopPropagation();
    ev.preventDefault();
});
RssDateTime.Show = function () {
    RssWin.MaskLayer.show();
    this.wrap.show();
    this.wrap.css({ "left": ($(window).width() - this.wrap.width()) / 2, "top": ($(window).height() - this.wrap.height()) / 2 })
}
RssDateTime.onSlideEnd = function () {

}

//以自定义属性方式引用控件
$("[rssdatetime]").click(function () {
    var t = $(this)
    RssDateTime.Init(t.attr("istime"));  //显示时间部分
    RssDateTime.Show();
    RssDateTime.onSlideEnd = function () {
        t.val(this.Result);
    }
});